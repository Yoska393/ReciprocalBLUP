---
title: "Untitled"
author: "Hayato Yoshioka"
date: "2025-10-20"
output: html_document
---

```{r}
library(here)
```

```{r}
selected_features<-readRDS(here("out","selected_features.rds"))
res_list<-readRDS(here("out","res_list.rds"))
```



```{r}
get_selected_features <- function(threshold = "0.1") {
  # threshold -> "thr0.1" 
  thr_name <- paste0("thr", threshold)

  list(
    dcg = selected_features[[thr_name]]$G_COM_W4,   # Genome->Com (Drought)
    ccg = selected_features[[thr_name]]$G_COM_W1,   # Genome->Com (Control)

    dc  = selected_features[[thr_name]]$MET_COM_W4, # Met->Com (Drought)
    cc  = selected_features[[thr_name]]$MET_COM_W1, # Met->Com (Control)

    dmg = selected_features[[thr_name]]$G_MET_W4,   # Genome->Met (Drought)
    cmg = selected_features[[thr_name]]$G_MET_W1,   # Genome->Met (Control)

    dm  = selected_features[[thr_name]]$COM_MET_W4, # Micro->Met (Drought)
    cm  = selected_features[[thr_name]]$COM_MET_W1  # Micro->Met (Control)
  )
}

thresholds <- c("0", "0.1", "0.2", "0.3", "0.4", "0.5")

f_list <- list()  # empty list

for (thr in thresholds) {
  feat <- get_selected_features(thr)
  f_d <- union(feat$dmg, feat$dm)   # Drought (G->Met + Micro->Met)
  f_c <- union(feat$cmg, feat$cm)   # Control (G->Met + Micro->Met)
  
  # 各thresholdの結果をリストに追加
  f_list[[paste0("thr",thr)]] <- list(
    f_d = f_d,
    f_c = f_c
  )
}

# 確認
str(f_list)

#saveRDS(f_list,here("data","threshold_metabo.rds"))

f_list <- list()  # empty list

for (thr in thresholds) {
  feat <- get_selected_features(thr)
  f_d <- union(feat$dcg, feat$dc)   
  f_c <- union(feat$ccg, feat$cc)   
  
  # 各threshold
  f_list[[paste0("thr",thr)]] <- list(
    f_d = f_d,
    f_c = f_c
  )
}

# check
str(f_list)

#saveRDS(f_list,here("data","threshold_micro.rds"))


```


```{r}
feat <- get_selected_features("0.1")  # thr01
dcg <- feat$dcg
ccg <- feat$ccg
dc  <- feat$dc
cc  <- feat$cc
dmg <- feat$dmg
cmg <- feat$cmg
dm  <- feat$dm
cm  <- feat$cm


f_d<- union(dmg, dm)
f_c<- union(cmg, cm)

```


```{r}

A <- dmg
B <- cmg
C <- dm
D <- cm

features_list <- list(
  a = setdiff(A, union(B, union(C, D))),
  b = setdiff(intersect(A, B), union(C, D)),
  c = setdiff(B, union(A, union(C, D))),
  d = setdiff(intersect(A, C), union(B, D)),
  e = setdiff(intersect(intersect(A, B), C), D),
  f = intersect(intersect(intersect(A, B), C), D),
  g = setdiff(intersect(intersect(A, B), D), C),
  h = setdiff(intersect(B, D), union(A, C)),
  i = setdiff(C, union(A, union(B, D))),
  j = setdiff(intersect(C, A), union(B, D)),
  k = setdiff(intersect(C, D), union(A, B)),
  l = setdiff(intersect(A, D), union(B, C)),
  m = setdiff(intersect(B, D), union(A, C)),
  n = setdiff(D, union(A, union(B, C))),
  o = setdiff(intersect(C, D), union(A, B))
)





```

```{r}
saveRDS(features_list,here("out",paste0("met01.rds")))
```


```{r}

A <- dcg
B <- ccg
C <- dc
D <- cc

features_list2 <- list(
  a = setdiff(A, union(B, union(C, D))),
  b = setdiff(intersect(A, B), union(C, D)),
  c = setdiff(B, union(A, union(C, D))),
  d = setdiff(intersect(A, C), union(B, D)),
  e = setdiff(intersect(intersect(A, B), C), D),
  f = intersect(intersect(intersect(A, B), C), D),
  g = setdiff(intersect(intersect(A, B), D), C),
  h = setdiff(intersect(B, D), union(A, C)),
  i = setdiff(C, union(A, union(B, D))),
  j = setdiff(intersect(C, A), union(B, D)),
  k = setdiff(intersect(C, D), union(A, B)),
  l = setdiff(intersect(A, D), union(B, C)),
  m = setdiff(intersect(B, D), union(A, C)),
  n = setdiff(D, union(A, union(B, C))),
  o = setdiff(intersect(C, D), union(A, B))  
)
```



```{r}
saveRDS(features_list2,here("out",paste0("micro01.rds")))

```


```{r}

# selected_features <- readRDS(here("out","selected_features.rds"))
# res_list <- readRDS(here("out","res_list.rds"))

## upper
frac_map <- c(p50 = 0.50, p25 = 0.25, p12_5 = 0.125, p6_25 = 0.0625)

## score
.col_scores_max <- function(x) {
  if (is.null(dim(x))) {
    sc <- as.numeric(x); names(sc) <- names(x); sc
  } else {
    apply(as.matrix(x), 2, function(col) max(col, na.rm = TRUE))
  }
}

## score
list_names <- names(res_list)
scores_by_nm <- setNames(vector("list", length(list_names)), list_names)
for (nm in list_names) {
  sc <- .col_scores_max(res_list[[nm]])
  sc[is.na(sc)] <- -Inf
  scores_by_nm[[nm]] <- sc
}

get_scores <- function(nm) {
  if (!is.null(scores_by_nm[[nm]])) scores_by_nm[[nm]] else setNames(numeric(0), character(0))
}


combine_max <- function(a, b) {
  keys <- union(names(a), names(b))
  av <- a[keys]; bv <- b[keys]
  av[is.na(av)] <- -Inf; bv[is.na(bv)] <- -Inf
  out <- pmax(av, bv); names(out) <- keys; out
}


slice_top_frac <- function(score_vec, frac) {
  if (length(score_vec) == 0) return(character(0))
  ord <- order(score_vec, names(score_vec), decreasing = TRUE)
  items <- names(score_vec)[ord]
  k <- max(1, ceiling(length(items) * frac))
  items[seq_len(k)]
}

## --- met（G_MET, COM_MET, BOTH） ---
sc_GW4 <- get_scores("G_MET_W4")
sc_CW4 <- get_scores("COM_MET_W4")
sc_GW1 <- get_scores("G_MET_W1")
sc_CW1 <- get_scores("COM_MET_W1")

## score for each
sc_G_drought <- sc_GW4
sc_G_control <- sc_GW1
sc_C_drought <- sc_CW4
sc_C_control <- sc_CW1

## combine
sc_B_drought <- combine_max(sc_GW4, sc_CW4)
sc_B_control <- combine_max(sc_GW1, sc_CW1)

## upper → percent → drought/control
met_sets <- list(
  G_MET  = setNames(vector("list", length(frac_map)), names(frac_map)),
  COM_MET= setNames(vector("list", length(frac_map)), names(frac_map)),
  BOTH   = setNames(vector("list", length(frac_map)), names(frac_map))
)

for (nm_frac in names(frac_map)) {
  f <- frac_map[[nm_frac]]

  met_sets$G_MET[[nm_frac]] <- list(
    drought = slice_top_frac(sc_G_drought, f),
    control = slice_top_frac(sc_G_control, f)
  )
  met_sets$COM_MET[[nm_frac]] <- list(
    drought = slice_top_frac(sc_C_drought, f),
    control = slice_top_frac(sc_C_control, f)
  )
  met_sets$BOTH[[nm_frac]] <- list(
    drought = slice_top_frac(sc_B_drought, f),
    control = slice_top_frac(sc_B_control, f)
  )
}

## check
str(met_sets, max.level = 3)


saveRDS(met_sets, here("data","percentile_met_sets_G_COM_BOTH.rds"))

## --- micro（G_COM, MET_COM, BOTH) ---


sc_GC_W4 <- get_scores("G_COM_W4")
sc_MC_W4 <- get_scores("MET_COM_W4")
sc_GC_W1 <- get_scores("G_COM_W1")
sc_MC_W1 <- get_scores("MET_COM_W1")


sc_GC_drought <- sc_GC_W4
sc_GC_control <- sc_GC_W1
sc_MC_drought <- sc_MC_W4
sc_MC_control <- sc_MC_W1


sc_BM_drought <- combine_max(sc_GC_W4, sc_MC_W4)
sc_BM_control <- combine_max(sc_GC_W1, sc_MC_W1)

# upper→ percent → down（drought/control）
micro_sets <- list(
  G_COM   = setNames(vector("list", length(frac_map)), names(frac_map)),
  MET_COM = setNames(vector("list", length(frac_map)), names(frac_map)),
  BOTH    = setNames(vector("list", length(frac_map)), names(frac_map))
)

for (nm_frac in names(frac_map)) {
  f <- frac_map[[nm_frac]]

  micro_sets$G_COM[[nm_frac]] <- list(
    drought = slice_top_frac(sc_GC_drought, f),
    control = slice_top_frac(sc_GC_control, f)
  )
  micro_sets$MET_COM[[nm_frac]] <- list(
    drought = slice_top_frac(sc_MC_drought, f),
    control = slice_top_frac(sc_MC_control, f)
  )
  micro_sets$BOTH[[nm_frac]] <- list(
    drought = slice_top_frac(sc_BM_drought, f),
    control = slice_top_frac(sc_BM_control, f)
  )
}

## check
str(micro_sets, max.level = 3)
# ex:
# micro_sets$BOTH$p50$drought
# micro_sets$G_COM$p12_5$control

## save
saveRDS(micro_sets, here("data","percentile_micro_sets_G_METCOM_BOTH.rds"))


```








