---
title: "b7_pattern"
author: "Hayato Yoshioka"
date: "2025-10-30"
output: html_document
---

```{r}
library(here)
```


```{r}
micro1<-readRDS(here("out",paste0("micro01.rds")))
met01 <-readRDS(here("out",paste0("met01.rds")))
```


```{r}
CD="W1"
```


data
```{r}
if (CD == "W4") {
  file_name <- "blup_drought.rds"
} else if (CD == "W1") {
  file_name <- "blup_control.rds"
} else {
  stop("CD must be W1 or W4")
}

blup_data <- readRDS(here::here("data/blup", file_name))

```


```{r}
pheno.sel.cd <- blup_data$pheno.sel.cd
var.id       <- blup_data$var.id
grm.cd       <- blup_data$grm.cd
plot.id      <- blup_data$plot.id
com.cd       <- blup_data$com.cd
met2.cd      <- blup_data$met2.cd
com2.cd     <- blup_data$com2.cd
```

```{r}

# 1. 距離行列を作成
dist_mat <- dist(t(met2.cd), method = "euclidean")  # または他の距離

# 2. PCoA の実行
pcoa_result <- cmdscale(dist_mat, k = 2, eig = TRUE)

# 3. 結果の確認
pcoa_result$points
pcoa_result$eig

# 4. プロット
plot(pcoa_result$points, 
     col = "blue", pch = 19, 
     xlab = "PCoA1", ylab = "PCoA2", 
     main = "Principal Coordinates Analysis")

```

```{r}

library(here)

# データ読み込み
met01 <- readRDS(here("out", "met01.rds"))

# 距離行列（変数間の類似性を見るため転置）
dist_mat <- dist(t(met2.cd), method = "euclidean")

# PCoAの実行
pcoa_result <- cmdscale(dist_mat, k = 2, eig = TRUE)
points <- as.data.frame(pcoa_result$points)

#--------------------------------------------
# クラスタ情報の統合
#--------------------------------------------
# met01 の中に a〜o の列があり、それぞれクラスタに属する変数名が入っている場合、
# これらをすべてまとめて、変数名ごとのクラスタラベルを作る

cluster_df <- data.frame(
  variable = unlist(met01, use.names = FALSE),            # 各クラスタの変数名
  cluster  = rep(names(met01), sapply(met01, length))     # a〜o のクラスタ名
)

# PCoA 結果の行名（変数名）とクラスタ対応付け
points$variable <- rownames(points)

# 変数に対応するクラスタラベルを付加
points <- merge(points, cluster_df, by = "variable", all.x = TRUE)

# a〜o に含まれないものを "other" とする
points$cluster[is.na(points$cluster)] <- "other"

#--------------------------------------------
# プロット
#--------------------------------------------
palette <- rainbow(length(unique(points$cluster)))

plot(points$V1, points$V2,
     col = palette[as.factor(points$cluster)],
     pch = 19,
     xlab = "PCoA1", ylab = "PCoA2",
     main = "PCoA by Cluster (a–o + other)")

legend("topright", legend = unique(points$cluster),
       col = palette, pch = 19, cex = 0.8)

```


```{r}
pca_result <- prcomp(met2.cd, scale. = TRUE)
summary(pca_result)
biplot(pca_result)

```

