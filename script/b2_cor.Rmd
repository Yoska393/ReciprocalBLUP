---
title: "b2_cor"
author: "Hayato Yoshioka"
date: "2025-10-16"
output: html_document
---


```{r}
library(here)
library(VennDiagram)
library(grid)
```

```{r}
# ヘルパー関数
read_row1_df <- function(file) {
  df <- read.csv(
    here("out/herit", file),
    row.names = 1,
    check.names = FALSE,
    stringsAsFactors = FALSE
  )
  df[1, , drop = FALSE]  # 1行目を data.frame として残す
}

gcomw4  <- read_row1_df("var_com_2019_W4_rainb.csv")
gcomw1  <- read_row1_df("var_com_2019_W1_rainb.csv")
gmetw4  <- read_row1_df("var_met_2019_W4_rainb.csv")
gmetw1  <- read_row1_df("var_met_2019_W1_rainb.csv")

metcomw4 <- read_row1_df("var_com_2019_metrmW4_rainb.csv")
metcomw1 <- read_row1_df("var_com_2019_metrmW1_rainb.csv")
commetw4 <- read_row1_df("var_met_2019_mrmW4_rainb.csv")
commetw1 <- read_row1_df("var_met_2019_mrmW1_rainb.csv")

res_list <- list(
  G_COM_W4   = gcomw4,
  G_COM_W1   = gcomw1,
  G_MET_W4   = gmetw4,
  G_MET_W1   = gmetw1,
  MET_COM_W4 = metcomw4,
  MET_COM_W1 = metcomw1,
  COM_MET_W4 = commetw4,
  COM_MET_W1 = commetw1
)


```

```{r}
res_list <- lapply(res_list, function(df) {
  df[] <- lapply(df, function(col) as.numeric(as.character(col)))
  df
})


```

```{r}
thresholds  <- c(0.5,0.4,0.3, 0.2, 0.1, 0)
list_names  <- names(res_list)
selected_features <- list()

for (thr in thresholds) {
  key_thr <- paste0("thr", thr)   # ← 文字キーにする
  selected_features[[key_thr]] <- list()  # ← サブリストを初期化
  for (nm in list_names) {
    sel <- res_list[[nm]][, res_list[[nm]] > thr, drop = FALSE]
    selected_features[[key_thr]][[nm]] <- colnames(sel)
  }
}

# 確認
str(selected_features, max.level = 1)

```

```{r}
saveRDS(res_list,here("out","res_list.rds"))
saveRDS(selected_features,here("out","selected_features.rds"))
```


```{r}
feature_counts <- sapply(selected_features, function(thr_list) {sapply(thr_list, length)})

full_counts <- sapply(res_list, ncol)

# feature_counts に列を追加
feature_counts <- cbind(feature_counts, Full = full_counts)

feature_counts
```



```{r}


data <- list(Drought = dc, Control = cc) 
venn.diagram(data, main = "G->Micro COR>0.1", fill = c(2, 3), # background color 
             alpha = c(0.5, 0.5), # transparency
             lty = c(1, 1), # border line type
             filename = here("out/ven","vencom.png"),
             main.cex =2.5,sub.cex = 4,cat.cex = 1.5,cex=3,width=4000,height=4000,margin = 0.2) 

dm <- selected_features$thr0.1$G_MET_W4
cm <- selected_features$thr0.1$G_MET_W1


data <- list(Drought = dm, Control = cm) 
venn.diagram(data, main = "G->Met COR>0.1", fill = c(2, 3), # background color
             alpha = c(0.5, 0.5), # transparency 
             lty = c(1, 1), # border line type 
             filename = here("out/ven","venmet.png"), 
             main.cex =2.5,sub.cex = 4,cat.cex = 1.5,cex=3,width=4000,height=4000,margin = 0.2)
```

```{r}
library(VennDiagram)
library(grid)
library(here)

# ==== データ（[1] は外す：全行名を取る） ====

dcg <- selected_features$thr0.1$G_COM_W4  
ccg <- selected_features$thr0.1$G_COM_W1

dc <- selected_features$thr0.1$MET_COM_W4  
cc <- selected_features$thr0.1$MET_COM_W1

dmg <- selected_features$thr0.1$G_MET_W4
cmg <- selected_features$thr0.1$G_MET_W1

dm <- selected_features$thr0.1$COM_MET_W4
cm <- selected_features$thr0.1$COM_MET_W1

# # =======================
# # 1) Met -> Micro（2セット）
# # =======================
# g1 <- .make_venn_grob(
#   x = list(Drought = dc, Control = cc),
#   fill = c("#E69F00", "#0072B2"),
#   alpha = c(0.5, 0.5),
#   lty = c(2, 2),
#   margin = 0.1,
#   cex = 3, cat.cex = 1.5
# )
# .draw_with_title(g1, "Met->Micro, COR>0.1", here("out/ven","vencom_bymet.png"),
#                  title_y = 0.95)
# 
# # =======================
# # 2) Micro -> Met（2セット）
# # =======================
# g2 <- .make_venn_grob(
#   x = list(Drought = dm, Control = cm),
#   fill = c("#E69F00", "#0072B2"),
#   alpha = c(0.5, 0.5),
#   lty = c(2, 2),
#   margin = 0.1,
#   cex = 3, cat.cex = 1.5
# )
# .draw_with_title(g2, "Micro->Met, COR>0.1", here("out/ven","venmet_bymicro.png"),
#                  title_y = 0.95)

# # =======================
# # 3) 4セット（Metabolome）
# # =======================
# data_met <- list(
#   "Micro->Met (D)"   = dm,
#   "Micro->Met (C)"   = cm,
#   "Genome->Met (D)"  = dmg,
#   "Genome->Met (C)"  = cmg
# )
# g3 <- .make_venn_grob(
#   x = data_met,
#   fill = c("#E69F00", "#0072B2","#E69F00", "#0072B2"),  # Drought = orange, Control = teal
#   alpha = rep(0.5, 4),
#   lty = c(2, 2, 1, 1),
#   margin = 0.1)
# .draw_with_title(g3, "Metabolome, COR>0.1", here("out/ven","venall_MET.png"),
#                  title_y = 0.94)
# 
# # =======================
# # 4) 4セット（Microbiome）
# # =======================
# data_micro <- list(
#   "Met->Micro (D)"   = dc,   # ← Miccro を修正
#   "Met->Micro (C)"   = cc,
#   "Genome->Micro (D)"= dcg,
#   "Genome->Micro (C)"= ccg
# )
# g4 <- .make_venn_grob(
#   x = data_micro,
#   fill = c("#E69F00", "#0072B2","#E69F00", "#0072B2"),
#   alpha = rep(0.5, 4),
#   lty = c(2, 2, 1, 1),
#   margin = 0.1
# )
# .draw_with_title(g4, "Microbiome, COR>0.1", here("out/ven","venall_MICRO.png"),
#                  title_y = 0.94)

```

```{r}
library(grid)


# 端末差異を吸収：ragg があれば使い、なければ通常 png()
.open_png <- function(path, width=4000, height=4000, res=300) {
  dir.create(dirname(path), recursive = TRUE, showWarnings = FALSE)
  if (requireNamespace("ragg", quietly = TRUE)) {
    ragg::agg_png(path, width = width, height = height, res = res)
  } else {
    png(path, width = width, height = height, res = res)
  }
}

# 共通ヘルパー：Venn grob を作成（タイトルは後で grid.text で）
.make_venn_grob <- function(x, fill, alpha, lty, margin=0.1,
                            cex=3, cat.cex=2) {
  venn.diagram(
    x = x,
    filename = NULL,     # ← ここが肝
    main = NULL,         # タイトルは後で描く
    fill = fill,
    alpha = alpha,
    lty = lty,
    margin = margin,
    cex = cex,
    cat.cex = cat.cex
  )
}

# タイトルを好きな高さに（0〜1：下→上）
.draw_with_title <- function(grob, title, out, title_y = 0.95,
                             title_size = 25, title_face = "bold") {
  .open_png(out)
  grid.draw(grob)
  grid.text(title, y = unit(title_y, "npc"),
            gp = gpar(fontsize = title_size, fontface = title_face))
  dev.off()
}


annotate_over_region_counts <- function(
  g, labels = NULL,
  dx = unit(-8, "pt"),
  dy = unit(1, "pt"),
  cex = 20,                # ← pt 単位で大きめのサイズ
  fontface = "bold"
) {
  grid.newpage()
  grid.draw(g)
  grid.force()

  ids <- grid.grep(grep = TRUE, "text", grobs = TRUE, global = TRUE)

  is_count_grob <- function(gpath) {
    gr <- grid.get(gpath)
    lbl <- tryCatch(gr$label, error = function(e) NULL)
    if (is.null(lbl)) return(FALSE)
    grepl("^[0-9,]+$", lbl)
  }
  count_paths <- Filter(is_count_grob, ids)
  if (length(count_paths) == 0) {
    message("数字ラベルの grob が見つかりませんでした。")
    return(invisible(NULL))
  }

  if (is.null(labels)) {
    labels <- paste0("(", letters[((seq_along(count_paths) - 1) %% 26) + 1], ")")
  } else {
    labels <- labels[seq_along(count_paths)]
  }

  for (i in seq_along(count_paths)) {
    p <- count_paths[[i]]
    x <- grobX(p, 1) + dx
    y <- grobY(p, 1) + dy
    grid.text(
      labels[i], x = x, y = y,
      just = c("left", "bottom"),
      gp = gpar(fontsize = cex, fontface = fontface)  # ★ ここを追加
    )
  }
  invisible(count_paths)
}


data_met <- list(
  "Micro->Met\n(Drought)"   = dm,
  "Micro->Met\n(Control)"   = cm,
  "Genome->Met\n(Drought)"  = dmg,
  "Genome->Met\n(Control)"  = cmg
)

g3 <- .make_venn_grob(
  x = data_met,
  fill = c("#E69F00", "#0072B2","#E69F00", "#0072B2"),
  alpha = rep(0.5, 4),
  lty = c(2, 2, 1, 1),
  margin = 0.1
) 

# 自動で (a)(b)(c)… を“数字のすぐ上”に配置
annotate_over_region_counts(g3)  # または labels = c("(a)","(b)",...)

png(here("out/ven","venall_MET_labeled.png"), width = 2000, height = 2000, res = 200)
annotate_over_region_counts(g3)  # grid.newpage()～描画を内包しているのでこれだけでOK
dev.off()


######


data_micro <- list(
  "Met->Micro\n(Drought)"   = dc,
  "Met->Micro\n(Control)"   = cc,
  "Genome->Micro\n(Drought)"= dcg,
  "Genome->Micro\n(Control)"= ccg
)


g3 <- .make_venn_grob(
  x = data_micro,
  fill = c("#E69F00", "#0072B2","#E69F00", "#0072B2"),
  alpha = rep(0.5, 4),
  lty = c(2, 2, 1, 1),
  margin = 0.1
) 

# 自動で (a)(b)(c)… を“数字のすぐ上”に配置
annotate_over_region_counts(g3)  # または labels = c("(a)","(b)",...)

png(here("out/ven","venall_MICRO_labeled.png"), width = 2000, height = 2000, res = 200)
annotate_over_region_counts(g3)  # grid.newpage()～描画を内包しているのでこれだけでOK
dev.off()


```




```{ echo=FALSE, fig.align='center', out.width='30%'}
knitr::include_graphics(here::here("out/ven", "venall_MET_labeled.png"))
```

```{ echo=FALSE, fig.align='center', out.width='30%'}
knitr::include_graphics(here::here("out/ven", "venall_MICRO_labeled.png"))
```








